<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solana Wallet Toolkit v5.1</title>
<style>
body{background-color:#000;color:#00ffb7;font-family:monospace;padding:20px}
h2{color:#00ffb7}
input,select,button{background:#111;color:#00ffb7;border:1px solid #00ffb7;border-radius:6px;padding:6px 10px;margin:4px}
button{cursor:pointer;font-weight:bold}
button:hover{background:#00ffb7;color:#000}
#logs{white-space:pre-wrap;font-size:13px;margin-top:10px}
.log-INFO{color:#00ffb7}.log-ERROR{color:#ff6060}.log-TX{color:#3affff}
.token-card{border:1px solid #00ffb7;border-radius:8px;padding:6px;margin:5px 0;background:#111}
.token-type{float:right;color:#3affff}
</style>
</head>
<body>
<h2>Solana Wallet Toolkit v5.1</h2>

<div>
  <label>RPC:</label>
  <select id="rpcSelect">
    <option value="https://solana-rpc.publicnode.com" selected>PublicNode (padrão)</option>
    <option value="https://api.mainnet-beta.solana.com">Mainnet Beta</option>
    <option value="https://api.devnet.solana.com">Devnet</option>
    <option value="https://api.testnet.solana.com">Testnet</option>
  </select>
  <button id="btnConnect">Conectar Carteira</button>
  <button id="btnRefresh">Atualizar Tokens</button>
</div><br>

<div>
  <label>Token Mint:</label><br>
  <input id="mintInput" placeholder="Token mint address" size="60"><br>
  <label>Destino:</label><br>
  <input id="destInput" placeholder="Carteira destino" size="60"><br>
  <label>Quantidade:</label><br>
  <input id="amountInput" placeholder="Quantidade"><br>
  <button id="btnSend">Enviar Token</button>
</div>

<h3>Tokens:</h3>
<div id="tokenList"></div>

<div id="logs"></div>

<script type="module">
import {
  Connection, PublicKey, Transaction, LAMPORTS_PER_SOL
} from "https://esm.sh/@solana/web3.js@1.95.3";
import {
  getAssociatedTokenAddress, createTransferInstruction, createAssociatedTokenAccountInstruction,
  TOKEN_PROGRAM_ID, TOKEN_2022_PROGRAM_ID
} from "https://esm.sh/@solana/spl-token@0.3.0";

window.Buffer = window.Buffer || {from:(s)=>new TextEncoder().encode(s)};

const logs = document.getElementById("logs");
function log(lvl,msg){const t=new Date().toISOString();logs.innerHTML += `\n${t} [${lvl}] ${msg}`;console.log(`[${lvl}]`,msg);}
const rpcSel=document.getElementById("rpcSelect");
let walletPubkey=null;

async function connectWallet(){
  try{
    if(window.solana?.isPhantom){
      const resp=await window.solana.connect();
      walletPubkey=new PublicKey(resp.publicKey.toString());
      log("INFO",`Carteira conectada: ${walletPubkey.toBase58()}`);
    }else{throw new Error("Phantom não detectado");}
  }catch(e){log("ERROR",e.message);}
}

async function detectProgram(connection,mintAddr){
  try{
    const info=await connection.getAccountInfo(new PublicKey(mintAddr));
    if(!info)return TOKEN_PROGRAM_ID;
    const owner=info.owner.toBase58();
    if(owner===TOKEN_2022_PROGRAM_ID.toBase58())return TOKEN_2022_PROGRAM_ID;
    return TOKEN_PROGRAM_ID;
  }catch{return TOKEN_PROGRAM_ID;}
}

async function getPriceUSD(){
  try{
    const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd");
    const j=await r.json();
    return j.solana.usd;
  }catch{return 0;}
}

async function refreshTokens(){
  if(!walletPubkey){log("ERROR","Conecte a carteira primeiro");return;}
  const rpc=rpcSel.value;
  const conn=new Connection(rpc,"confirmed");
  log("INFO","Atualizando tokens...");
  const tokenListDiv=document.getElementById("tokenList");
  tokenListDiv.innerHTML="";

  const ataList=await conn.getParsedTokenAccountsByOwner(walletPubkey,{programId:TOKEN_PROGRAM_ID});
  const ataList22=await conn.getParsedTokenAccountsByOwner(walletPubkey,{programId:TOKEN_2022_PROGRAM_ID});
  const allAccounts=[...ataList.value,...ataList22.value];
  const solBal=await conn.getBalance(walletPubkey);
  const solPrice=await getPriceUSD();
  log("INFO",`Saldo SOL: ${(solBal/LAMPORTS_PER_SOL).toFixed(4)} (~$${(solBal/LAMPORTS_PER_SOL*solPrice).toFixed(2)})`);

  for(const acc of allAccounts){
    try{
      const info=acc.account.data.parsed.info;
      const mint=info.mint;
      const amt=parseFloat(info.tokenAmount.uiAmountString);
      const prog=acc.account.owner.toBase58()===TOKEN_2022_PROGRAM_ID.toBase58()?"SPL-2022":"SPL";
      const card=document.createElement("div");
      card.className="token-card";
      card.innerHTML=`<b>${mint}</b><span class='token-type'>${prog}</span><br>Qtd: ${amt}`;
      tokenListDiv.appendChild(card);
    }catch(e){log("ERROR",e.message);}
  }
  log("INFO","Tokens atualizados");
}

async function sendToken(){
  if(!walletPubkey){log("ERROR","Conecte a carteira primeiro");return;}
  const rpc=rpcSel.value;
  const conn=new Connection(rpc,"confirmed");
  const mintAddr=document.getElementById("mintInput").value.trim();
  const destAddr=document.getElementById("destInput").value.trim();
  const amt=parseFloat(document.getElementById("amountInput").value.trim());
  if(!mintAddr||!destAddr||!amt){log("ERROR","Campos incompletos");return;}
  try{
    const mint=new PublicKey(mintAddr);
    const to=new PublicKey(destAddr);
    const program=await detectProgram(conn,mintAddr);
    const fromAta=await getAssociatedTokenAddress(mint,walletPubkey,false,program);
    const toAta=await getAssociatedTokenAddress(mint,to,false,program);
    const infoTo=await conn.getAccountInfo(toAta);
    const tx=new Transaction();
    if(!infoTo){tx.add(createAssociatedTokenAccountInstruction(walletPubkey,toAta,walletPubkey,mint,program));}
    tx.add(createTransferInstruction(fromAta,toAta,walletPubkey,amt*1e9,[],program));
    const {blockhash}=await conn.getLatestBlockhash();
    tx.recentBlockhash=blockhash;tx.feePayer=walletPubkey;
    const signed=await window.solana.signTransaction(tx);
    const sig=await conn.sendRawTransaction(signed.serialize());
    log("TX",`Transação enviada: https://solscan.io/tx/${sig}`);
  }catch(e){log("ERROR",e.message);}
}

document.getElementById("btnConnect").onclick=connectWallet;
document.getElementById("btnRefresh").onclick=refreshTokens;
document.getElementById("btnSend").onclick=sendToken;
</script>
</body>
</html>