<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- CSP compatível com file:// e localhost -->
<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' data:; connect-src * blob: data:;">

<title>Airdrop 27 coin — Devnet Dashboard</title>
<style>
  :root{
    --gap:12px;
    --muted:#666;
    --bg:#f7f8fa;
    --card:#fff;
    --accent:#0b74ff;
    --danger:#d9534f;
    --success:#28a745;
    --info:#007bff;
    --shadow: 0 6px 18px rgba(20,20,30,0.06);
  }
  *{box-sizing:border-box}
  body{
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin:0;
    padding:18px;
    background:var(--bg);
    color:#111;
  }

  .container{
    max-width:1100px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 1fr;
    gap:var(--gap);
  }

  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  header h1{font-size:18px;margin:0}
  header p{margin:0;color:var(--muted);font-size:13px}

  /* Grid for dashboard */
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:var(--gap);
  }

  .card{
    background:var(--card);
    padding:12px;
    border-radius:10px;
    box-shadow:var(--shadow);
  }

  .balance{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .balance .amount{font-size:22px;font-weight:600}
  .small{font-size:13px;color:var(--muted)}

  button{
    border:0;padding:10px 12px;border-radius:8px;background:var(--accent);
    color:white;font-weight:600;cursor:pointer;
  }
  button.secondary{background:#555}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
  button:disabled{opacity:.5;cursor:not-allowed}

  .logs{max-height:220px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:6px;font-family:monospace;font-size:13px}
  .log-item{padding:8px;border-radius:6px;background:#fbfcff;border:1px solid #eef2ff}
  .log-item.error{border-color:rgba(217,83,79,0.15);color:var(--danger)}
  .log-item.success{border-color:rgba(40,167,69,0.12);color:var(--success)}
  .log-item.info{border-color:rgba(0,123,255,0.08);color:var(--info)}

  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;text-align:left;border-bottom:1px solid #eef2ff}
  th{background:#fbfcff;font-weight:700}
  .tx-highlight{background:linear-gradient(90deg,rgba(11,116,255,0.06),transparent)}
  .tx-ok{color:var(--success);font-weight:700}
  .tx-bad{color:var(--danger);font-weight:700}

  .muted{color:var(--muted);font-size:13px}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Airdrop 27 coin — Devnet</h1>
      <p>Painel de envio, status e histórico (mobile + desktop)</p>
    </div>
    <div class="controls">
      <button id="connectBtn">Conectar Phantom</button>
      <button id="disconnectBtn" class="secondary" style="display:none">Desconectar</button>
      <button id="sendBtn" style="display:none">Enviar Airdrop (0.00527 SOL)</button>
      <button id="refreshTxBtn" class="ghost">Atualizar TX</button>
    </div>
  </header>

  <div class="grid">
    <!-- 1️⃣ Card: Dados -->
    <div class="card balance">
      <div>
        <div class="small">Carteira</div>
        <div id="walletAddr" class="muted">—</div>
      </div>
      <div>
        <div class="small">Saldo (SOL)</div>
        <div id="balance" class="amount">—</div>
        <div class="note">Atualiza automaticamente após cada transação</div>
      </div>
      <div>
        <div class="small">Memo (fixo)</div>
        <div id="memoText" class="muted">Inscrito Airdrop 27 coin</div>
      </div>
    </div>

    <!-- 2️⃣ Card: Logs -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Status / Logs</strong>
        <div class="muted">Últimos 100</div>
      </div>
      <div id="logs" class="logs" aria-live="polite"></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="clearLogs" class="ghost">Limpar logs</button>
      </div>
    </div>

    <!-- 3️⃣ Card: Transações -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Últimas transações (20)</strong>
        <div class="muted">Busca por transações recentes</div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table id="txTable" role="table" aria-live="polite">
          <thead><tr><th>Sig</th><th>Slot</th><th>Direção</th><th>Valor</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note">Transações para o endereço do airdrop aparecem como <strong>"Airdrop 27 coin confirmado!"</strong></div>
    </div>
  </div>
</div>

<!-- Biblioteca Web3 -->
<script src="./web3.iife.min.js"></script>
<script>
  // Polyfill Buffer para browser
  if (typeof window.Buffer === 'undefined') {
    window.Buffer = {
      from: (data, enc) => new TextEncoder().encode(data)
    };
  }

  (function(){
    const RPC_ENDPOINT = 'https://api.devnet.solana.com';
    const DESTINATION_ADDRESS = '2ZjGzzYYiPwHXchTcVMzikH8v9kY6y5tFnmcNJauK1XD';
    const AIRDROP_AMOUNT = 0.00527;
    const MEMO_TEXT = 'Inscrito Airdrop 27 coin';
    const TX_HISTORY_LIMIT = 20;
    const LOG_LIMIT = 100;
    const RETRY_SEND_ATTEMPTS = 2;

    const connection = new solanaWeb3.Connection(RPC_ENDPOINT, 'confirmed');
    let wallet = null;
    let publicKey = null;
    let isProcessing = false;
    let logs = [];

    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const refreshTxBtn = document.getElementById('refreshTxBtn');
    const clearLogsBtn = document.getElementById('clearLogs');
    const logsDiv = document.getElementById('logs');
    const balanceEl = document.getElementById('balance');
    const walletAddrEl = document.getElementById('walletAddr');
    const txTableBody = document.querySelector('#txTable tbody');

    function ts(){ return new Date().toISOString().replace('T',' ').slice(0,19); }
    function short(sig){ return sig ? sig.slice(0,8)+'...' : '—';}
    function sol(lamports){ return (lamports / solanaWeb3.LAMPORTS_PER_SOL).toFixed(6); }
    function pushLog(message, level='info'){
      const entry = {ts:ts(), msg:message, level};
      logs.unshift(entry);
      if(logs.length>LOG_LIMIT) logs = logs.slice(0,LOG_LIMIT);
      renderLogs();
      console.log(`[${entry.ts}] ${message}`);
    }
    function renderLogs(){
      logsDiv.innerHTML = '';
      for(const e of logs){
        const div = document.createElement('div');
        div.className = 'log-item ' + (e.level);
        div.textContent = `[${e.ts}] ${e.msg}`;
        logsDiv.appendChild(div);
      }
    }
    async function refreshBalance(){
      if(!publicKey) return;
      const lamports = await connection.getBalance(publicKey);
      balanceEl.textContent = sol(lamports) + ' SOL';
      pushLog('Saldo atualizado: ' + sol(lamports) + ' SOL', 'info');
    }

    async function connectWallet(){
      try {
        if(!window.solana?.isPhantom){
          pushLog('Phantom Wallet não detectada.', 'error');
          return;
        }
        wallet = window.solana;
        const resp = await wallet.connect();
        publicKey = resp.publicKey;
        walletAddrEl.textContent = publicKey.toBase58();
        pushLog('Conectado: ' + publicKey.toBase58(), 'success');
        connectBtn.style.display = 'none';
        disconnectBtn.style.display = 'inline-block';
        sendBtn.style.display = 'inline-block';
        await refreshBalance();
        await refreshTxHistory();
      } catch (err){
        pushLog('Erro ao conectar: ' + err.message, 'error');
      }
    }

    async function sendAirdrop(){
      if(!wallet || !publicKey) return pushLog('Conecte sua Phantom.', 'error');
      if(isProcessing) return;
      isProcessing = true;
      sendBtn.disabled = true;
      try {
        const latest = await connection.getLatestBlockhash('finalized');
        const tx = new solanaWeb3.Transaction().add(
          solanaWeb3.SystemProgram.transfer({
            fromPubkey: publicKey,
            toPubkey: new solanaWeb3.PublicKey(DESTINATION_ADDRESS),
            lamports: Math.round(AIRDROP_AMOUNT * solanaWeb3.LAMPORTS_PER_SOL)
          }),
          new solanaWeb3.TransactionInstruction({
            keys: [],
            programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),
            data: Buffer.from(MEMO_TEXT, 'utf8')
          })
        );
        tx.recentBlockhash = latest.blockhash;
        tx.feePayer = publicKey;

        const signed = await wallet.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize(), {skipPreflight:false});
        pushLog('Transação enviada: ' + sig, 'info');
        await connection.confirmTransaction({signature:sig, blockhash:latest.blockhash, lastValidBlockHeight:latest.lastValidBlockHeight}, 'confirmed');
        pushLog('✅ Airdrop enviado com sucesso!', 'success');
        await refreshBalance();
        await refreshTxHistory();
      } catch(err){
        pushLog('Erro: ' + err.message, 'error');
      }
      isProcessing = false;
      sendBtn.disabled = false;
    }

    async function refreshTxHistory(){
      if(!publicKey) return;
      try {
        pushLog('Buscando últimas transações...', 'info');
        const sigs = await connection.getSignaturesForAddress(publicKey, {limit:TX_HISTORY_LIMIT});
        const rows = [];
        for(const s of sigs){
          rows.push({signature:s.signature, slot:s.slot, status:s.err?'failed':'confirmed'});
        }
        renderTx(rows);
      } catch(err){
        pushLog('Erro histórico: ' + err.message, 'error');
      }
    }

    function renderTx(rows){
      txTableBody.innerHTML = '';
      if(!rows.length){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5" class="muted">Nenhuma transação recente</td>';
        txTableBody.appendChild(tr);
        return;
      }
      for(const r of rows){
        const tr = document.createElement('tr');
        const a = document.createElement('a');
        a.textContent = short(r.signature);
        a.href = `https://explorer.solana.com/tx/${r.signature}?cluster=devnet`;
        a.target = '_blank';
        const sigTd = document.createElement('td'); sigTd.appendChild(a);
        tr.innerHTML = `<td></td><td>${r.slot}</td><td>—</td><td>—</td><td>${r.status}</td>`;
        tr.replaceChild(sigTd, tr.children[0]);
        txTableBody.appendChild(tr);
      }
    }

    connectBtn.onclick = connectWallet;
    disconnectBtn.onclick = ()=>location.reload();
    sendBtn.onclick = sendAirdrop;
    refreshTxBtn.onclick = refreshTxHistory;
    clearLogsBtn.onclick = ()=>{ logs=[]; renderLogs(); };

    pushLog('Dashboard inicializado', 'info');
    pushLog('Pronto. Conecte sua Phantom e envie o airdrop.', 'info');
  })();
</script>
</body>
</html>
