<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' data:;">
<title>Airdrop 27 coin ‚Äî Devnet Dashboard</title>
<style>
  :root{
    --gap:12px;--muted:#666;--bg:#f7f8fa;--card:#fff;--accent:#0b74ff;
    --danger:#d9534f;--success:#28a745;--info:#007bff;
    --shadow:0 6px 18px rgba(20,20,30,0.06);
  }
  *{box-sizing:border-box}body{font-family:Inter,system-ui;
  margin:0;padding:18px;background:var(--bg);color:#111;}
  .container{max-width:1100px;margin:0 auto;display:grid;gap:var(--gap);}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  header h1{font-size:18px;margin:0}header p{margin:0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr;gap:var(--gap);}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow);}
  .balance{display:flex;flex-direction:column;gap:8px;}
  .balance .amount{font-size:22px;font-weight:600}.small{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{border:0;padding:10px 12px;border-radius:8px;background:var(--accent);
  color:white;font-weight:600;cursor:pointer;}
  button.secondary{background:#555}button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
  button:disabled{opacity:.5;cursor:not-allowed}
  .logs{max-height:220px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:6px;
  font-family:monospace;font-size:13px}
  .log-item{padding:8px;border-radius:6px;background:#fbfcff;border:1px solid #eef2ff}
  .log-item.error{border-color:rgba(217,83,79,0.15);color:var(--danger)}
  .log-item.success{border-color:rgba(40,167,69,0.12);color:var(--success)}
  .log-item.info{border-color:rgba(0,123,255,0.08);color:var(--info)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;text-align:left;border-bottom:1px solid #eef2ff}
  th{background:#fbfcff;font-weight:700}
  .tx-highlight{background:linear-gradient(90deg,rgba(11,116,255,0.06),transparent)}
  .tx-ok{color:var(--success);font-weight:700}
  .tx-bad{color:var(--danger);font-weight:700}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .muted{color:var(--muted);font-size:13px}.note{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Airdrop 27 coin ‚Äî Devnet</h1>
      <p>Painel de envio, status e hist√≥rico (mobile + desktop)</p>
    </div>
    <div class="controls">
      <button id="connectBtn">Conectar Phantom</button>
      <button id="disconnectBtn" class="secondary" style="display:none">Desconectar</button>
      <button id="sendBtn" style="display:none">Enviar Airdrop (0.00527 SOL)</button>
      <button id="refreshTxBtn" class="ghost">Atualizar TX</button>
    </div>
  </header>

  <div class="grid">
    <div class="card balance">
      <div><div class="small">Carteira</div><div id="walletAddr" class="muted">‚Äî</div></div>
      <div><div class="small">Saldo (SOL)</div><div id="balance" class="amount">‚Äî</div>
        <div class="note">Atualiza automaticamente ap√≥s transa√ß√µes</div></div>
      <div><div class="small">Memo (fixo)</div><div id="memoText" class="muted">Inscrito Airdrop 27 coin</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Status / Logs</strong></div><div class="muted">√∫ltimos 100</div>
      </div>
      <div id="logs" class="logs" aria-live="polite"></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="clearLogs" class="ghost">Limpar logs</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>√öltimas transa√ß√µes (20)</strong></div><div class="muted">Busca por transa√ß√µes recentes</div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table id="txTable" role="table" aria-live="polite">
          <thead><tr><th>Sig</th><th>Slot</th><th>Dire√ß√£o</th><th>Valor</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note">Transa√ß√µes para o endere√ßo do airdrop s√£o destacadas com <strong>"Airdrop 27 coin confirmado!"</strong></div>
    </div>
  </div>
</div>

<script src="./web3.iife.min.js"></script>
<script>
(async function(){

  const RPC='https://api.devnet.solana.com';
  const DEST='2ZjGzzYYiPwHXchTcVMzikH8v9kY6y5tFnmcNJauK1XD';
  const MEMO='Inscrito Airdrop 27 coin';
  const AMT=0.00527;
  const LOGS_MAX=100;
  const TX_LIMIT=20;

  const conn=new solanaWeb3.Connection(RPC,'confirmed');
  let wallet=null,pk=null,isBusy=false,logs=[];

  const $=id=>document.getElementById(id);
  const log=(m,l='info')=>{
    const t=new Date().toLocaleTimeString('pt-BR');
    logs.unshift({t,m,l}); if(logs.length>LOGS_MAX) logs.pop();
    renderLogs();
    console.log(`[${t}] ${m}`);
  };
  const renderLogs=()=>{
    const el=$('logs'); el.innerHTML='';
    for(const x of logs){
      const d=document.createElement('div');
      d.className='log-item '+(x.l==='error'?'error':x.l==='success'?'success':'info');
      d.textContent=`[${x.t}] ${x.m}`; el.appendChild(d);
    }
  };

  async function connect(){
    if(!window.solana||!window.solana.isPhantom) return log('Phantom n√£o detectada','error');
    wallet=window.solana; log('Tentando conectar...','info');
    const r=await wallet.connect(); pk=r.publicKey;
    $('walletAddr').textContent=pk.toBase58();
    $('connectBtn').style.display='none'; $('disconnectBtn').style.display='inline-block';
    log('Conectado: '+pk.toBase58(),'success');
    await updateBalance();
    await checkEligibilityAndShowButton();
    await refreshTxs();
  }

  async function disconnect(){
    try{wallet.disconnect();}catch{}
    wallet=null; pk=null;
    $('walletAddr').textContent='‚Äî'; $('balance').textContent='‚Äî';
    $('connectBtn').style.display='inline-block'; $('disconnectBtn').style.display='none';
    $('sendBtn').style.display='none';
    log('Desconectado.','info');
  }

  async function updateBalance(){
    if(!pk) return;
    const lam=await conn.getBalance(pk);
    $('balance').textContent=(lam/solanaWeb3.LAMPORTS_PER_SOL).toFixed(6)+' SOL';
  }

  async function checkEligibilityAndShowButton(){
    $('sendBtn').style.display='none';
    log('Verificando elegibilidade...','info');
    const eligible=await detectRegistrationFullScan();
    if(eligible){
      log('üö´ Usu√°rio j√° inscrito ‚Äî envio bloqueado.','info');
    }else{
      log('‚úÖ Usu√°rio apto para o airdrop','success');
      $('sendBtn').style.display='inline-block';
      $('sendBtn').disabled=false;
    }
  }

  async function detectRegistrationFullScan(){
    if(!pk) return false;
    log('Iniciando varredura completa do hist√≥rico (pode levar alguns segundos)...','info');
    try{
      const sigs=await conn.getSignaturesForAddress(pk,{limit:1000});
      for(const s of sigs){
        const tx=await safeGetParsedTransaction(s.signature);
        if(!tx) continue;
        const instr=tx.transaction.message.instructions||[];
        let hasMemo=false,hasDest=false;
        for(const ix of instr){
          if(ix.program==='system'&&ix.parsed?.info?.destination===DEST) hasDest=true;
          if(ix.parsed?.type==='memo'||ix.parsed?.memo===MEMO||ix.parsed===MEMO) hasMemo=true;
        }
        if(hasMemo&&hasDest){
          log('Registro de inscri√ß√£o encontrado em tx: '+s.signature,'success');
          return true;
        }
      }
    }catch(e){
      log('Erro na varredura: '+(e.message||e),'error');
    }
    log('Nenhum registro de inscri√ß√£o encontrado ‚Äî apto.','info');
    return false;
  }

  async function safeGetParsedTransaction(sig){
    let delay=2500;
    for(let i=0;i<6;i++){
      try{
        const tx=await conn.getParsedTransaction(sig,'confirmed');
        if(tx) return tx;
      }catch(e){
        if(e.message.includes('429')){
          log(`Rate limit, retry em ${delay}ms`,'info');
          await new Promise(r=>setTimeout(r,delay));
          delay*=2;
        }else break;
      }
    }
    return null;
  }

  async function sendAirdrop(){
    if(!wallet||!pk||isBusy) return;
    isBusy=true;
    $('sendBtn').disabled=true;
    log('Iniciando envio do airdrop...','info');
    let attempt=0;
    while(attempt<2){
      attempt++;
      try{
        log(`Obtendo latest blockhash (tentativa ${attempt})`,'info');
        const {blockhash,lastValidBlockHeight}=await conn.getLatestBlockhash('finalized');
        const tx=new solanaWeb3.Transaction({recentBlockhash:blockhash,feePayer:pk});
        tx.add(solanaWeb3.SystemProgram.transfer({fromPubkey:pk,toPubkey:new solanaWeb3.PublicKey(DEST),lamports:Math.round(AMT*solanaWeb3.LAMPORTS_PER_SOL)}));
        const memoProg=new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr');
        tx.add(new solanaWeb3.TransactionInstruction({keys:[],programId:memoProg,data:new TextEncoder().encode(MEMO)}));

        log('Solicitando assinatura na carteira (Phantom)...','info');
        const signed=await wallet.signTransaction(tx);
        const raw=signed.serialize();
        log('Transa√ß√£o assinada localmente.','info');
        const sig=await conn.sendRawTransaction(raw,{skipPreflight:false});
        log('Assinatura enviada: '+sig,'info');

        const ok=await confirmTx(sig,blockhash,lastValidBlockHeight);
        if(ok){ log('‚úÖ Transa√ß√£o confirmada: '+sig,'success'); break; }
      }catch(e){
        const m=e.message||e;
        if(m.includes('Blockhash not found')||m.includes('expired')){
          log('Blockhash expirado ou inv√°lido ‚Äî retryando (nova tentativa).','info');
          continue;
        }
        if(m.includes('already been processed')){
          log('Transa√ß√£o j√° processada segundo o RPC. Tratando como sucesso.','info');
          break;
        }
        log('Erro ao enviar: '+m,'error');
      }
    }
    await refreshTxs();
    await updateBalance();
    await checkEligibilityAndShowButton();
    isBusy=false;
  }

  async function confirmTx(sig,blockhash,lastValidBlockHeight){
    log('Aguardando confirma√ß√£o (confirmTransaction) ...','info');
    try{
      const res=await conn.confirmTransaction({signature:sig,blockhash,lastValidBlockHeight},'confirmed');
      if(res?.value?.err===null) return true;
      log('confirmTransaction falhou, iniciando polling (fallback)...','info');
      for(let i=0;i<10;i++){
        await new Promise(r=>setTimeout(r,2000));
        const st=await conn.getSignatureStatus(sig);
        if(st?.value?.confirmationStatus==='confirmed'||st?.value?.confirmationStatus==='finalized'){
          log('‚úÖ Transa√ß√£o confirmada via polling: '+sig,'success');
          return true;
        }
      }
    }catch(e){
      log('Erro na confirma√ß√£o: '+(e.message||e),'error');
    }
    return false;
  }

  async function refreshTxs(){
    if(!pk) return;
    log('Atualizando √∫ltimas transa√ß√µes...','info');
    const sigs=await conn.getSignaturesForAddress(pk,{limit:TX_LIMIT});
    const tbody=document.querySelector('#txTable tbody');
    tbody.innerHTML='';
    for(const s of sigs){
      const tr=document.createElement('tr');
      const link=document.createElement('a');
      link.href=`https://explorer.solana.com/tx/${s.signature}?cluster=devnet`;
      link.textContent=s.signature.slice(0,8)+'...';
      link.target='_blank';
      tr.innerHTML=`<td></td><td>${s.slot}</td><td>${s.err?'out':'in'}</td><td>‚Äî</td><td>${s.err?'failed':'confirmed'}</td>`;
      tr.children[0].appendChild(link);
      tbody.appendChild(tr);
    }
  }

  $('connectBtn').onclick=connect;
  $('disconnectBtn').onclick=disconnect;
  $('sendBtn').onclick=sendAirdrop;
  $('refreshTxBtn').onclick=refreshTxs;
  $('clearLogs').onclick=()=>{logs=[];renderLogs();log('Logs limpos.','info');};

  log('Dashboard inicializado.','info');

})();
</script>
</body>
</html>
