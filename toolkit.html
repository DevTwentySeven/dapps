<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solana Wallet Toolkit v5.4</title>
<meta name="description" content="d'Apps" />
<meta name="author" content="Dev Twenty Seven" />
<link rel="icon" href="/assets/icons/27-mini-icon.png" type="image/png">
<style>
body{background-color:#000;color:#00ffb7;font-family:monospace;padding:20px}
h2{color:#00ffb7}
input,select,button{background:#111;color:#00ffb7;border:1px solid #00ffb7;border-radius:6px;padding:6px 10px;margin:4px}
button{cursor:pointer;font-weight:bold}
button:hover{background:#00ffb7;color:#000}
#logs{white-space:pre-wrap;font-size:13px;margin-top:10px}
.log-INFO{color:#00ffb7}.log-ERROR{color:#ff6060}.log-TX{color:#3affff}
.token-card{border:1px solid #00ffb7;border-radius:8px;padding:6px;margin:5px 0;background:#111}
.token-type{float:right;color:#3affff}
.small{font-size:13px;color:#39ffb5cc}
.footer{margin-top:12px;color:#8fb7a3;font-size:12px}
</style>
</head>
<body>
<h2>Solana Wallet Toolkit v5.4</h2>
<div>
  <label>RPC:</label>
  <select id="rpcSelect">
    <option value="https://solana-rpc.publicnode.com" selected>PublicNode (padrão)</option>
    <option value="https://api.mainnet-beta.solana.com">Mainnet Beta</option>
    <option value="https://api.devnet.solana.com">Devnet</option>
    <option value="https://api.testnet.solana.com">Testnet</option>
    <option value="custom">Custom...</option>
  </select>
  <input id="customRpc" placeholder="RPC custom..." style="display:none;width:420px;margin-left:8px" />
  <button id="btnConnect">Conectar Carteira</button>
  <button id="btnRefresh">Atualizar Tokens</button>
</div><br>
<div>
  <label>Token Mint:</label><br>
  <input id="mintInput" placeholder="Token mint address" size="60"><br>
  <label>Destino:</label><br>
  <input id="destInput" placeholder="Carteira destino" size="60"><br>
  <label>Quantidade:</label><br>
  <input id="amountInput" placeholder="Quantidade"><br>
  <label>Memo (opcional):</label><br>
  <input id="memoInput" placeholder="Texto memo" size="60"><br>
  <button id="btnSend">Enviar Token</button>
</div>
<h3>Tokens:</h3>
<div id="tokenList"></div>
<div id="logs"></div>
<div class="footer">Nota: teste em Devnet antes de operar em Mainnet. PublicNode é o padrão.</div>
<script type="module">
import {
  Connection, PublicKey, Transaction, TransactionInstruction, LAMPORTS_PER_SOL, SystemProgram
} from "https://esm.sh/@solana/web3.js@1.95.3";
import {
  getAssociatedTokenAddress, createTransferInstruction, createAssociatedTokenAccountInstruction,
  TOKEN_PROGRAM_ID, TOKEN_2022_PROGRAM_ID, ASSOCIATED_TOKEN_PROGRAM_ID
} from "https://esm.sh/@solana/spl-token@0.3.0";
window.Buffer = window.Buffer || { from: (s) => new TextEncoder().encode(s) };
const logsEl = document.getElementById("logs");
function pushLog(level, msg){const t=new Date().toISOString();logsEl.innerHTML += `\n${t} [${level}] ${msg}`;console.log(`[${level}]`,msg);}
const rpcSelect=document.getElementById("rpcSelect");
const customRpcInput=document.getElementById("customRpc");
const btnConnect=document.getElementById("btnConnect");
const btnRefresh=document.getElementById("btnRefresh");
const btnSend=document.getElementById("btnSend");
const mintInput=document.getElementById("mintInput");
const destInput=document.getElementById("destInput");
const amountInput=document.getElementById("amountInput");
const memoInput=document.getElementById("memoInput");
const tokenListDiv=document.getElementById("tokenList");
let walletPubkey=null;
let connection=null;
rpcSelect.onchange=()=>{customRpcInput.style.display=rpcSelect.value==='custom'?'inline-block':'none';};
function getRpcUrl(){return rpcSelect.value==='custom'?(customRpcInput.value.trim()||'https://solana-rpc.publicnode.com'):rpcSelect.value;}
async function ensureConnection(){
  const rpc=getRpcUrl();
  if(!connection||connection.rpcEndpoint!==rpc){
    connection=new Connection(rpc,"confirmed");
    try{await connection.getVersion();pushLog('INFO',`Conectado RPC: ${rpc}`);}catch(e){pushLog('ERROR',`Falha RPC ${rpc}: ${e.message||e}`);}
  }
}
async function connectWallet(){
  try{
    await ensureConnection();
    if(!window.solana||!window.solana.isPhantom){alert('Instale a Phantom Wallet');return;}
    const resp=await window.solana.connect();
    walletPubkey=new PublicKey(resp.publicKey.toString());
    pushLog('INFO',`Carteira conectada: ${walletPubkey.toBase58()}`);
    await refreshTokens();
  }catch(e){pushLog('ERROR',`Connect wallet failed: ${e.message||e}`);}
}
const SYSTEM_PROGRAM_ID=new PublicKey('11111111111111111111111111111111');
async function detectProgram(mintAddr){
  try{
    const mintPub=new PublicKey(mintAddr);
    const info=await connection.getAccountInfo(mintPub);
    if(info&&info.owner){
      const owner=info.owner;
      if(owner.equals(SYSTEM_PROGRAM_ID))return null;
      if(owner.equals(TOKEN_2022_PROGRAM_ID))return TOKEN_2022_PROGRAM_ID;
      if(owner.equals(TOKEN_PROGRAM_ID))return TOKEN_PROGRAM_ID;
      return TOKEN_PROGRAM_ID;
    }
    return TOKEN_PROGRAM_ID;
  }catch(e){pushLog('ERROR',`detectProgram failed: ${e.message||e}`);return TOKEN_PROGRAM_ID;}
}
async function getMintDecimals(mintAddr){
  try{
    const mintInfo=await connection.getParsedAccountInfo(new PublicKey(mintAddr));
    const decimals=mintInfo?.value?.data?.parsed?.info?.decimals;
    return typeof decimals==='number'?decimals:9;
  }catch{return 9;}
}
async function refreshTokens(){
  try{
    if(!walletPubkey){pushLog('ERROR','Conecte a carteira primeiro');return;}
    await ensureConnection();
    tokenListDiv.innerHTML='';
    const classic=await connection.getParsedTokenAccountsByOwner(walletPubkey,{programId:TOKEN_PROGRAM_ID});
    const v22=await connection.getParsedTokenAccountsByOwner(walletPubkey,{programId:TOKEN_2022_PROGRAM_ID});
    const combined=[...(classic?.value||[]),...(v22?.value||[])];
    const lamports=await connection.getBalance(walletPubkey);
    const sol=lamports/LAMPORTS_PER_SOL;
    pushLog('INFO',`Saldo SOL: ${sol.toFixed(6)}`);
    for(const a of combined){
      const info=a.account.data.parsed.info;
      const mint=info.mint;
      const amt=info.tokenAmount.uiAmountString;
      const prog=a.account.owner.toBase58()===TOKEN_2022_PROGRAM_ID.toBase58()?'SPL-2022':'SPL';
      const card=document.createElement('div');
      card.className='token-card';
      card.innerHTML=`<b>${mint}</b><span class='token-type'>${prog}</span><br>Qtd: ${amt}`;
      tokenListDiv.appendChild(card);
    }
  }catch(e){pushLog('ERROR','refreshTokens failed: '+(e.message||e));}
}
async function sendToken(){
  try{
    if(!walletPubkey){pushLog('ERROR','Conecte a carteira primeiro');return;}
    await ensureConnection();
    const mintAddr=mintInput.value.trim();
    const dest=destInput.value.trim();
    const amt=parseFloat(amountInput.value.trim());
    const memo=memoInput.value.trim();
    if(!mintAddr||!dest||!amt){pushLog('ERROR','Campos incompletos');return;}
    const mintPub=new PublicKey(mintAddr);
    const destPub=new PublicKey(dest);
    const program=await detectProgram(mintAddr);
    if(program===null){
      pushLog('INFO','Enviando SOL nativo...');
      const lamports=amt*LAMPORTS_PER_SOL;
      const tx=new Transaction().add(SystemProgram.transfer({fromPubkey:walletPubkey,toPubkey:destPub,lamports}));
      if(memo)tx.add(new TransactionInstruction({keys:[],programId:new PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),data:Buffer.from(memo)}));
      tx.recentBlockhash=(await connection.getLatestBlockhash()).blockhash;tx.feePayer=walletPubkey;
      const signed=await window.solana.signTransaction(tx);
      const sig=await connection.sendRawTransaction(signed.serialize());
      pushLog('TX',`Transação SOL enviada: ${sig}`);return;
    }
    const decimals=await getMintDecimals(mintAddr);
    const integerUnits=BigInt(Math.floor(amt*(10**decimals)));
    const fromAta=await getAssociatedTokenAddress(mintPub,walletPubkey,false,program);
    const toAta=await getAssociatedTokenAddress(mintPub,destPub,false,program);
    const tx=new Transaction();
    const infoTo=await connection.getAccountInfo(toAta);
    if(!infoTo)tx.add(createAssociatedTokenAccountInstruction(walletPubkey,toAta,destPub,mintPub,program));
    tx.add(createTransferInstruction(fromAta,toAta,walletPubkey,integerUnits,[],program));
    if(memo)tx.add(new TransactionInstruction({keys:[],programId:new PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),data:Buffer.from(memo)}));
    tx.recentBlockhash=(await connection.getLatestBlockhash()).blockhash;tx.feePayer=walletPubkey;
    const signed=await window.solana.signTransaction(tx);
    const sig=await connection.sendRawTransaction(signed.serialize());
    pushLog('TX',`Transação enviada: https://solscan.io/tx/${sig}`);
  }catch(e){pushLog('ERROR','sendToken failed: '+(e.message||e));}
}
btnConnect.onclick=connectWallet;btnRefresh.onclick=refreshTokens;btnSend.onclick=sendToken;
(async()=>{await ensureConnection();})();</script></body></html>
